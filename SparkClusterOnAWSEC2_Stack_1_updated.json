{
	"AWSTemplateFormatVersion": "2010-09-09",
	"Description" : "This template is used to create Stack for SparkClusterUsingAWSEC2 utility.",
	"Parameters" : {
		"SparkClusterCIDR" : {
			"Description": "Provide the IP4 CIDR block that will be used by the VPC.",
			"Type": "String",
			"AllowedPattern" : "[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}/[0-9]{1,3}"
		},
		"SparkClusterWhitelistIP" : {
			"Description": "Provide the Ip of the servers to be whitelisted to the cluster.",
			"Type": "String",
			"AllowedPattern" : "[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}/[0-9]{1,3}"
		}
	},
	"Resources" : {
		"SparkClusterVPC" : {
			"Type" : "AWS::EC2::VPC",
			"Properties" : {
				"CidrBlock" : {
					"Ref" : "SparkClusterCIDR"
				},
				"EnableDnsHostnames" : true,
				"EnableDnsSupport" : true,
				"Tags" : [
					{
					   "Key" : "Project",
					   "Value" : "SparkCluster"
					},
					{
					   "Key" : "Name",
					   "Value" : "SparkClusterVPC"
					}
				]
			}
		},
		"SparkClusterSubnet1" : {
			"Type" : "AWS::EC2::Subnet",
			"Properties" : {
				"AvailabilityZone" : "us-east-1a",
				"CidrBlock" : {
					"Fn::Select" : [
						0,
						{
							"Fn::Cidr" : [
								{
									"Fn::GetAtt" : [ "SparkClusterVPC", "CidrBlock" ]
								},
								2,
								9
							]
						}
					]
				},
				"MapPublicIpOnLaunch" : true,
				"Tags" : [
					{
					   "Key" : "Project",
					   "Value" : "SparkCluster"
					},
					{
					   "Key" : "Name",
					   "Value" : "SparkClusterSubnet1"
					}
				],
				"VpcId" : {
					"Ref" : "SparkClusterVPC"
				}
			}
		},
		"SparkClusterSubnet2" : {
			"Type" : "AWS::EC2::Subnet",
			"Properties" : {
				"AvailabilityZone" : "us-east-1b",
				"CidrBlock" : {
					"Fn::Select" : [
						1,
						{
							"Fn::Cidr" : [
								{
									"Fn::GetAtt" : [ "SparkClusterVPC", "CidrBlock" ]
								},
								2,
								9
							]
						}
					]
				},
				"MapPublicIpOnLaunch" : true,
				"Tags" : [
					{
					   "Key" : "Project",
					   "Value" : "SparkCluster"
					},
					{
					   "Key" : "Name",
					   "Value" : "SparkClusterSubnet2"
					}
				],
				"VpcId" : {
					"Ref" : "SparkClusterVPC"
				}
			}
		},
		"SparkClusterSecurityGroup" : {
			"Type" : "AWS::EC2::SecurityGroup",
			"Properties" : {
				"GroupDescription" : "This securty group will filter inbound and outbound traffic to the cluster.",
				"GroupName" : "SparkClusterSecurityGroup",
				"Tags" : [
					{
					   "Key" : "Project",
					   "Value" : "SparkCluster"
					},
					{
					   "Key" : "Name",
					   "Value" : "SparkClusterVPC"
					}
				],
				"VpcId" : {
					"Ref" : "SparkClusterVPC"
				}
			}
		},
		"SparkClusterSGIngress1": {
			"Type": "AWS::EC2::SecurityGroupIngress",
			"Properties": {
				"GroupId": { 
					"Ref": "SparkClusterSecurityGroup"
				},
				"IpProtocol": "-1",
				"FromPort": "-1",
				"ToPort": "-1",
				"CidrIp": {
					"Fn::GetAtt" : [ "SparkClusterVPC", "CidrBlock" ]
				}
			}
		},
		"SparkClusterSGIngress2": {
			"Type": "AWS::EC2::SecurityGroupIngress",
			"Properties": {
				"GroupId": { 
					"Ref": "SparkClusterSecurityGroup"
				},
				"IpProtocol": "-1",
				"FromPort": "-1",
				"ToPort": "-1",
				"CidrIp": {
					"Ref" : "SparkClusterWhitelistIP"
				}
			}
		},
		"SparkClusterSGEgress": {
			"Type": "AWS::EC2::SecurityGroupEgress",
			"Properties": {
				"GroupId": { 
					"Ref": "SparkClusterSecurityGroup"
				},
				"IpProtocol": "-1",
				"FromPort": "-1",
				"ToPort": "-1",
				"CidrIp": "0.0.0.0/0"
			}
		}
	},
	"Outputs" : {
		"VPCId" : {
			"Description": "The VPC ID",  
			"Value" : { "Ref" : "SparkClusterVPC" }
		},
		"SubnetId1" : {
			"Description": "The Subnet ID",  
			"Value" : { "Ref" : "SparkClusterSubnet1" }
		},
		"SubnetId2" : {
			"Description": "The Subnet ID",  
			"Value" : { "Ref" : "SparkClusterSubnet2" }
		},
		"SecurityGroupId" : {
			"Description": "The Security Group ID",  
			"Value" : { "Ref" : "SparkClusterSecurityGroup" }
		}
	}
}